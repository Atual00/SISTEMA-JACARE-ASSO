<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão de Associação</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bibliotecas para Geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .module-content, .tab-content {
            display: none;
        }
        .module-content.active, .tab-content.active {
            display: block;
        }
        .tab-link.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        main {
            position: relative;
            z-index: 1;
        }
        main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--watermark-bg);
            background-repeat: no-repeat;
            background-position: center;
            background-size: 50%;
            opacity: 0.05;
            z-index: -1;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 text-white flex flex-col no-print">
            <div class="h-20 flex items-center justify-center border-b border-gray-700">
                <img id="sidebar-logo" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNGI1YjY5IiByeD0iMjAiIHJ5PSIyMCIvPgogIDx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMThweCIgZmlsbD0iI2ZmZmZmZiI+QTwvdGV4dD4KPC9zdmc+" class="h-10 w-10 rounded-full" alt="Logo da Associação">
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="#" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-gray-700" data-module="dashboard">
                    <i class="fas fa-tachometer-alt w-6 text-center"></i><span class="ml-3">Dashboard</span>
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-gray-700" data-module="associados">
                    <i class="fas fa-users w-6 text-center"></i><span class="ml-3">Associados</span>
                </a>
                 <a href="#" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-gray-700" data-module="eventos">
                    <i class="fas fa-calendar-alt w-6 text-center"></i><span class="ml-3">Eventos</span>
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-gray-700" data-module="produtos">
                    <i class="fas fa-box-open w-6 text-center"></i><span class="ml-3">Produtos</span>
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-gray-700" data-module="financeiro">
                    <i class="fas fa-dollar-sign w-6 text-center"></i><span class="ml-3">Financeiro</span>
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-gray-700" data-module="relatorios">
                    <i class="fas fa-chart-pie w-6 text-center"></i><span class="ml-3">Relatórios</span>
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-gray-700" data-module="configuracoes">
                    <i class="fas fa-cog w-6 text-center"></i><span class="ml-3">Configurações</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 lg:p-10 overflow-auto">
            
            <!-- Módulo Dashboard -->
            <div id="dashboard" class="module-content active">
                <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-500">Total de Associados</h3>
                        <p id="total-associados" class="text-4xl font-bold mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-500">Associados Ativos</h3>
                        <p id="associados-ativos" class="text-4xl font-bold mt-2 text-green-500">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-500">Inadimplentes</h3>
                        <p id="total-inadimplentes" class="text-4xl font-bold mt-2 text-red-500">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-500">Saldo em Caixa</h3>
                        <p id="saldo-caixa" class="text-4xl font-bold mt-2 text-blue-500">R$ 0,00</p>
                    </div>
                </div>
            </div>

            <!-- Módulo Associados -->
            <div id="associados" class="module-content">
                <h2 class="text-3xl font-bold mb-6">Gestão de Associados</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <button id="btn-novo-associado" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-4"><i class="fas fa-plus mr-2"></i>Novo Associado</button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="search-associado" placeholder="Buscar por nome..." class="w-full p-2 border rounded-lg">
                        <select id="filter-associado-status" class="w-full p-2 border rounded-lg">
                            <option value="todos">Todos os Status</option>
                            <option value="ativo">Ativos</option>
                            <option value="inativo">Inativos</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="p-3">Nome</th>
                                    <th class="p-3">Email</th>
                                    <th class="p-3">Telefone</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3">Mensalidade</th>
                                    <th class="p-3 no-print">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-associados"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Módulo Eventos -->
            <div id="eventos" class="module-content">
                <h2 class="text-3xl font-bold mb-6">Gestão de Eventos</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <button id="btn-novo-evento" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-4"><i class="fas fa-plus mr-2"></i>Novo Evento</button>
                    <div id="lista-eventos" class="space-y-4"></div>
                </div>
            </div>

            <!-- Módulo Produtos -->
            <div id="produtos" class="module-content">
                <h2 class="text-3xl font-bold mb-6">Gestão de Produtos</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <button id="btn-novo-produto" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-4"><i class="fas fa-plus mr-2"></i>Novo Produto</button>
                    <div id="lista-produtos" class="space-y-4"></div>
                </div>
            </div>

            <!-- Módulo Financeiro -->
            <div id="financeiro" class="module-content">
                <h2 class="text-3xl font-bold mb-6">Controle Financeiro</h2>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <a href="#" class="tab-link active" data-tab="lancamentos-tab">Lançamentos</a>
                        <a href="#" class="tab-link" data-tab="mensalidades-tab">Mensalidades</a>
                    </nav>
                </div>

                <div id="lancamentos-tab" class="tab-content active">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Lançamentos no Caixa</h3>
                            <select id="filter-lancamento-tipo" class="p-2 border rounded-lg">
                                <option value="todos">Todos os Tipos</option>
                                <option value="receita">Receitas</option>
                                <option value="despesa">Despesas</option>
                            </select>
                        </div>
                        <div class="flex space-x-4 mb-6">
                            <button id="btn-nova-receita" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600"><i class="fas fa-plus mr-2"></i>Nova Receita</button>
                            <button id="btn-nova-despesa" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600"><i class="fas fa-minus mr-2"></i>Nova Despesa</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-gray-200">
                                        <th class="p-3">Data</th>
                                        <th class="p-3">Descrição</th>
                                        <th class="p-3">Valor</th>
                                        <th class="p-3">Tipo</th>
                                        <th class="p-3 no-print">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-lancamentos"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="mensalidades-tab" class="tab-content">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <button id="btn-gerar-mensalidades" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 mb-4"><i class="fas fa-cogs mr-2"></i>Gerar Mensalidades do Mês</button>
                        <div id="lista-mensalidades-container" class="space-y-6"></div>
                    </div>
                </div>

            </div>

            <!-- Módulo Relatórios -->
            <div id="relatorios" class="module-content">
                <h2 class="text-3xl font-bold mb-6">Relatórios</h2>
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-bold mb-4">Filtros</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="filtro-data-inicio" class="block text-sm font-medium text-gray-700">Data de Início</label>
                            <input type="date" id="filtro-data-inicio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="filtro-data-fim" class="block text-sm font-medium text-gray-700">Data de Fim</label>
                            <input type="date" id="filtro-data-fim" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Relatórios Financeiros</h3>
                        <button class="block w-full text-left bg-gray-200 p-3 rounded-lg hover:bg-gray-300 mb-2" onclick="gerarRelatorio('fluxo-caixa')">Fluxo de Caixa</button>
                        <button class="block w-full text-left bg-gray-200 p-3 rounded-lg hover:bg-gray-300" onclick="gerarRelatorio('financeiro-consolidado')">Financeiro Consolidado</button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Relatórios de Associados</h3>
                        <button class="block w-full text-left bg-gray-200 p-3 rounded-lg hover:bg-gray-300 mb-2" onclick="gerarRelatorio('inadimplentes')">Inadimplentes</button>
                        <button class="block w-full text-left bg-gray-200 p-3 rounded-lg hover:bg-gray-300" onclick="gerarRelatorio('associados-status')">Associados por Status</button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Relatórios Operacionais</h3>
                        <button class="block w-full text-left bg-gray-200 p-3 rounded-lg hover:bg-gray-300 mb-2" onclick="gerarRelatorio('eventos')">Eventos</button>
                        <div id="relatorios-produtos-container"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Comunicação</h3>
                        <button class="block w-full text-left bg-teal-500 text-white p-3 rounded-lg hover:bg-teal-600" onclick="gerarRelatorio('aviso-mensalidade')">Gerar Aviso de Mensalidade</button>
                    </div>
                </div>
                <div id="relatorio-gerado" class="mt-8"></div>
            </div>

            <!-- Módulo Configurações -->
            <div id="configuracoes" class="module-content">
                <h2 class="text-3xl font-bold mb-6">Configurações</h2>
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Logotipo da Associação</h3>
                        <p class="mb-2">Faça o upload do logotipo que será exibido no sistema e nos relatórios.</p>
                        <input type="file" id="logo-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        <img id="logo-preview" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiB2aWV3Qm94PSIwIDAgMTUwIDE1MCI+CiAgPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2YxZjVmOSIvPgogIDx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjRweCIgZmlsbD0iIzQ3NTU2OSI+TG9nbzwvdGV4dD4KPC9zdmc+" class="mt-4 h-24 w-24 rounded-full object-cover" alt="Pré-visualização do Logo">
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Parâmetros Financeiros</h3>
                        <div>
                            <label for="dia-vencimento" class="block mb-1 font-medium">Dia do Vencimento Padrão da Mensalidade</label>
                            <input type="number" id="dia-vencimento" min="1" max="28" class="w-full p-2 border rounded-lg mb-4" value="10">
                        </div>
                         <div>
                            <label for="chave-pix" class="block mb-1 font-medium">Chave PIX da Associação</label>
                            <input type="text" id="chave-pix" class="w-full p-2 border rounded-lg" placeholder="Digite a chave PIX aqui">
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Usuários do Sistema</h3>
                        <button id="btn-novo-usuario" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-4"><i class="fas fa-user-plus mr-2"></i>Novo Usuário</button>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-gray-200">
                                        <th class="p-3">Nome</th>
                                        <th class="p-3">Email</th>
                                        <th class="p-3">Permissão</th>
                                        <th class="p-3 no-print">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-usuarios"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal Genérico -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg transform transition-all scale-95 opacity-0" id="modal-content"></div>
    </div>


    <script>
        // --- BANCO DE DADOS EM MEMÓRIA (MOCK) ---
        let associadosDB = [
            { id: 1, nome: 'Carlos Silva', email: 'carlos@email.com', telefone: '11999998888', status: 'ativo', mensalidade: 150.00, endereco: 'Rua Exemplo, 123', historico: [{ data: '2023-01-15', evento: 'Cadastro inicial' }] },
            { id: 2, nome: 'Maria Oliveira', email: 'maria@email.com', telefone: '21988887777', status: 'ativo', mensalidade: 120.00, endereco: 'Av. Teste, 456', historico: [{ data: '2023-02-20', evento: 'Cadastro inicial' }] },
            { id: 3, nome: 'João Pereira', email: 'joao@email.com', telefone: '31977776666', status: 'inativo', mensalidade: 100.00, endereco: 'Praça Modelo, 789', historico: [{ data: '2023-03-10', evento: 'Cadastro inicial' }, { data: '2024-05-01', evento: 'Status alterado para inativo' }] },
        ];
        let financasDB = [
            { id: 1, data: '2025-07-10', descricao: 'Mensalidade Carlos Silva', valor: 150.00, tipo: 'receita' },
            { id: 2, data: '2025-08-03', descricao: 'Compra de material de escritório', valor: -75.50, tipo: 'despesa' },
            { id: 3, data: '2025-09-20', descricao: 'Pagamento total do evento: Churrasco de Confraternização', valor: -300.00, tipo: 'despesa' },
            { id: 4, data: '2025-09-21', descricao: 'Reembolso Evento: Churrasco de Confraternização - Carlos Silva', valor: 150.00, tipo: 'receita' },
            { id: 5, data: '2025-09-21', descricao: 'Reembolso Evento: Churrasco de Confraternização - Maria Oliveira', valor: 150.00, tipo: 'receita' },
        ];
        let mensalidadesDB = [
            { id: 1, associadoId: 1, vencimento: '2025-07-10', valor: 150.00, status: 'paga' },
            { id: 2, associadoId: 2, vencimento: '2025-07-10', valor: 120.00, status: 'em_aberto' },
            { id: 3, associadoId: 1, vencimento: '2025-08-10', valor: 150.00, status: 'em_aberto' },
            { id: 4, associadoId: 2, vencimento: '2025-08-10', valor: 120.00, status: 'em_aberto' },
        ];
        let eventosDB = [
            { id: 1, nome: 'Churrasco de Confraternização', data: '2025-09-20', valorTotal: 300.00, pagoPelaAssociacao: true, participantes: [{id: 1, pago: true}, {id: 2, pago: true}] },
            { id: 2, nome: 'Pizza de Sexta', data: '2025-10-05', valorTotal: 100.00, pagoPelaAssociacao: false, participantes: [{id: 1, pago: false}, {id: 2, pago: true}] }
        ];
        let produtosDB = [
            { id: 1, nome: 'Camiseta Comemorativa 2025', custoTotal: 500.00, variacoes: ['P', 'M', 'G', 'GG'], pedidos: [ { associadoId: 1, variacao: 'M', pago: true }, { associadoId: 2, variacao: 'G', pago: false } ] }
        ];
        let usuariosDB = [
            { id: 1, nome: 'Admin Geral', email: 'admin@sistema.com', permissao: 'Administrador' }
        ];
        let config = {
            diaVencimentoPadrao: 10,
            chavePix: ''
        };
        let logoURL = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiB2aWV3Qm94PSIwIDAgMTUwIDE1MCI+CiAgPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2YxZjVmOSIvPgogIDx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjRweCIgZmlsbD0iIzQ3NTU2OSI+TG9nbzwvdGV4dD4KPC9zdmc+';

        // --- FUNÇÃO UTILITÁRIA PARA DATAS ---
        function formatarData(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }
        
        // --- FUNÇÃO PARA ATUALIZAR A MARCA D'ÁGUA ---
        function updateWatermark() {
            document.documentElement.style.setProperty('--watermark-bg', `url(${logoURL})`);
        }

        // --- LÓGICA DE NAVEGAÇÃO ---
        const navLinks = document.querySelectorAll('.nav-link');
        const modules = document.querySelectorAll('.module-content');
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');

        function showModule(moduleId) {
            modules.forEach(module => module.classList.toggle('active', module.id === moduleId));
            if (moduleId === 'relatorios') {
                renderBotoesRelatorioProduto();
            }
        }
        
        function showTab(tabId) {
            tabContents.forEach(tab => tab.classList.toggle('active', tab.id === tabId));
            tabLinks.forEach(link => link.classList.toggle('active', link.dataset.tab === tabId));
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showModule(link.dataset.module);
            });
        });
        
        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showTab(link.dataset.tab);
            });
        });

        // --- LÓGICA DOS MÓDULOS ---
        document.addEventListener('DOMContentLoaded', () => {
            renderAssociados();
            renderLancamentos();
            renderMensalidades();
            renderEventos();
            renderProdutos();
            renderUsuarios();
            updateDashboard();
            updateWatermark();
            document.getElementById('dia-vencimento').value = config.diaVencimentoPadrao;
            document.getElementById('chave-pix').value = config.chavePix;
            
            // Adiciona listeners para os novos filtros
            document.getElementById('search-associado').addEventListener('input', renderAssociados);
            document.getElementById('filter-associado-status').addEventListener('change', renderAssociados);
            document.getElementById('filter-lancamento-tipo').addEventListener('change', renderLancamentos);

            showModule('dashboard');
            showTab('lancamentos-tab');
        });

        // --- DASHBOARD ---
        function updateDashboard() {
            document.getElementById('total-associados').textContent = associadosDB.length;
            document.getElementById('associados-ativos').textContent = associadosDB.filter(a => a.status === 'ativo').length;
            
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('total-inadimplentes').textContent = mensalidadesDB.filter(m => m.status === 'em_aberto' && m.vencimento < hoje).length;

            const saldo = financasDB.reduce((acc, item) => acc + item.valor, 0);
            document.getElementById('saldo-caixa').textContent = `R$ ${saldo.toFixed(2).replace('.', ',')}`;
        }


        // --- ASSOCIADOS ---
        function renderAssociados() {
            const lista = document.getElementById('lista-associados');
            const filtroNome = document.getElementById('search-associado').value.toLowerCase();
            const filtroStatus = document.getElementById('filter-associado-status').value;

            lista.innerHTML = '';
            const filteredAssociados = associadosDB.filter(a => {
                const matchNome = a.nome.toLowerCase().includes(filtroNome);
                const matchStatus = (filtroStatus === 'todos') || (a.status === filtroStatus);
                return matchNome && matchStatus;
            });

            if (filteredAssociados.length === 0) {
                lista.innerHTML = '<tr><td colspan="6" class="p-3 text-center text-gray-500">Nenhum associado encontrado.</td></tr>';
                return;
            }

            filteredAssociados.forEach(assoc => {
                const statusClass = assoc.status === 'ativo' ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100';
                const row = `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-medium">${assoc.nome}</td>
                        <td class="p-3">${assoc.email}</td>
                        <td class="p-3">${assoc.telefone}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded-full text-sm font-semibold ${statusClass}">${assoc.status}</span></td>
                        <td class="p-3">R$ ${assoc.mensalidade.toFixed(2).replace('.', ',')}</td>
                        <td class="p-3 no-print">
                            <button class="text-blue-600 hover:text-blue-800 mr-3" onclick="abrirModalAssociado(${assoc.id})"><i class="fas fa-edit"></i></button>
                            <button class="text-gray-500 hover:text-gray-700 mr-3" onclick="verHistorico(${assoc.id})"><i class="fas fa-history"></i></button>
                            <button class="text-red-600 hover:text-red-800" onclick="toggleStatusAssociado(${assoc.id})"><i class="fas fa-power-off"></i></button>
                        </td>
                    </tr>
                `;
                lista.innerHTML += row;
            });
        }
        
        document.getElementById('btn-novo-associado').addEventListener('click', () => abrirModalAssociado());

        function abrirModalAssociado(id = null) {
            const associado = id ? associadosDB.find(a => a.id === id) : null;
            const modalContent = document.getElementById('modal-content');
            
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">${associado ? 'Editar Associado' : 'Novo Associado'}</h2>
                <form id="form-associado">
                    <input type="hidden" id="associado-id" value="${associado?.id || ''}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="nome" class="block mb-1 font-medium">Nome Completo</label><input type="text" id="nome" class="w-full p-2 border rounded-lg" value="${associado?.nome || ''}" required></div>
                        <div><label for="email" class="block mb-1 font-medium">Email</label><input type="email" id="email" class="w-full p-2 border rounded-lg" value="${associado?.email || ''}" required></div>
                        <div><label for="telefone" class="block mb-1 font-medium">Telefone</label><input type="tel" id="telefone" class="w-full p-2 border rounded-lg" value="${associado?.telefone || ''}"></div>
                        <div><label for="endereco" class="block mb-1 font-medium">Endereço</label><input type="text" id="endereco" class="w-full p-2 border rounded-lg" value="${associado?.endereco || ''}"></div>
                        <div><label for="mensalidade" class="block mb-1 font-medium">Valor da Mensalidade (R$)</label><input type="number" step="0.01" id="mensalidade" class="w-full p-2 border rounded-lg" value="${associado?.mensalidade || ''}" required></div>
                        <div><label for="status" class="block mb-1 font-medium">Status</label><select id="status" class="w-full p-2 border rounded-lg"><option value="ativo" ${associado?.status === 'ativo' ? 'selected' : ''}>Ativo</option><option value="inativo" ${associado?.status === 'inativo' ? 'selected' : ''}>Inativo</option></select></div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-4"><button type="button" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400" onclick="fecharModal()">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar</button></div>
                </form>
            `;

            document.getElementById('form-associado').addEventListener('submit', salvarAssociado);
            mostrarModal();
        }

        function salvarAssociado(e) {
            e.preventDefault();
            const id = document.getElementById('associado-id').value;
            const nome = document.getElementById('nome').value;
            const email = document.getElementById('email').value;
            const telefone = document.getElementById('telefone').value;
            const endereco = document.getElementById('endereco').value;
            const mensalidade = parseFloat(document.getElementById('mensalidade').value);
            const status = document.getElementById('status').value;

            if (id) {
                const index = associadosDB.findIndex(a => a.id == id);
                const original = associadosDB[index];
                if (original.status !== status) associadosDB[index].historico.push({ data: new Date().toISOString().split('T')[0], evento: `Status alterado de ${original.status} para ${status}` });
                if (original.mensalidade !== mensalidade) associadosDB[index].historico.push({ data: new Date().toISOString().split('T')[0], evento: `Mensalidade alterada de R$ ${original.mensalidade.toFixed(2)} para R$ ${mensalidade.toFixed(2)}` });
                associadosDB[index] = { ...associadosDB[index], nome, email, telefone, endereco, mensalidade, status };
            } else {
                const novoId = associadosDB.length > 0 ? Math.max(...associadosDB.map(a => a.id)) + 1 : 1;
                associadosDB.push({ id: novoId, nome, email, telefone, endereco, mensalidade, status, historico: [{ data: new Date().toISOString().split('T')[0], evento: 'Cadastro inicial' }] });
            }

            renderAssociados();
            updateDashboard();
            fecharModal();
        }
        
        function toggleStatusAssociado(id) {
            const index = associadosDB.findIndex(a => a.id === id);
            if (index !== -1) {
                const originalStatus = associadosDB[index].status;
                associadosDB[index].status = originalStatus === 'ativo' ? 'inativo' : 'ativo';
                associadosDB[index].historico.push({ data: new Date().toISOString().split('T')[0], evento: `Status alterado de ${originalStatus} para ${associadosDB[index].status}` });
                renderAssociados();
                updateDashboard();
            }
        }

        function verHistorico(id) {
            const associado = associadosDB.find(a => a.id === id);
            if (!associado) return;
            let historicoHtml = '<ul class="space-y-2">';
            associado.historico.forEach(item => {
                historicoHtml += `<li class="p-2 bg-gray-100 rounded-md"><strong>${formatarData(item.data)}:</strong> ${item.evento}</li>`;
            });
            historicoHtml += '</ul>';
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">Histórico de ${associado.nome}</h2>${historicoHtml}<div class="mt-6 flex justify-end"><button type="button" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400" onclick="fecharModal()">Fechar</button></div>`;
            mostrarModal();
        }

        // --- EVENTOS ---
        function renderEventos() {
            const lista = document.getElementById('lista-eventos');
            lista.innerHTML = '';
            if (eventosDB.length === 0) {
                lista.innerHTML = '<p class="text-center text-gray-500">Nenhum evento cadastrado.</p>';
                return;
            }
            eventosDB.forEach(evento => {
                const valorIndividual = evento.participantes.length > 0 ? (evento.valorTotal / evento.participantes.length).toFixed(2) : '0.00';
                const card = `
                    <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">${evento.nome}</h3>
                                <p class="text-sm text-gray-600">Data: ${formatarData(evento.data)}</p>
                                <p class="text-sm text-gray-600">Participantes: ${evento.participantes.length}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">Valor Total: R$ ${evento.valorTotal.toFixed(2).replace('.', ',')}</p>
                                <p class="font-semibold text-blue-600">Valor por Pessoa: R$ ${valorIndividual.replace('.', ',')}</p>
                                <button class="mt-2 text-sm bg-gray-200 px-3 py-1 rounded-lg hover:bg-gray-300" onclick="abrirModalDetalhesEvento(${evento.id})">Ver Detalhes</button>
                            </div>
                        </div>
                    </div>
                `;
                lista.innerHTML += card;
            });
        }

        document.getElementById('btn-novo-evento').addEventListener('click', () => abrirModalEvento());

        function abrirModalEvento(id = null) {
            const evento = id ? eventosDB.find(e => e.id === id) : null;
            const associadosAtivos = associadosDB.filter(a => a.status === 'ativo');
            let options = '';
            associadosAtivos.forEach(a => {
                const isSelected = evento ? evento.participantes.some(p => p.id === a.id) : false;
                options += `<option value="${a.id}" ${isSelected ? 'selected' : ''}>${a.nome}</option>`;
            });

            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">${evento ? 'Editar Evento' : 'Novo Evento'}</h2>
                <form id="form-evento">
                    <input type="hidden" id="evento-id" value="${evento?.id || ''}">
                    <div class="space-y-4">
                        <div><label for="nome-evento" class="block mb-1 font-medium">Nome do Evento</label><input type="text" id="nome-evento" class="w-full p-2 border rounded-lg" value="${evento?.nome || ''}" required></div>
                        <div><label for="data-evento" class="block mb-1 font-medium">Data</label><input type="date" id="data-evento" class="w-full p-2 border rounded-lg" value="${evento?.data || new Date().toISOString().split('T')[0]}" required></div>
                        <div><label for="valor-total-evento" class="block mb-1 font-medium">Valor Total (R$)</label><input type="number" step="0.01" id="valor-total-evento" class="w-full p-2 border rounded-lg" value="${evento?.valorTotal || ''}" required></div>
                        <div class="flex items-center">
                            <input type="checkbox" id="pago-pela-associacao" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${evento?.pagoPelaAssociacao ? 'checked' : ''}>
                            <label for="pago-pela-associacao" class="ml-2 block text-sm text-gray-900">Evento pago pela associação</label>
                        </div>
                        <div>
                            <label for="participantes-evento" class="block mb-1 font-medium">Participantes</label>
                            <select id="participantes-evento" multiple class="w-full p-2 border rounded-lg h-40">
                                ${options}
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-4"><button type="button" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400" onclick="fecharModal()">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Evento</button></div>
                </form>
            `;
            document.getElementById('form-evento').addEventListener('submit', salvarEvento);
            mostrarModal();
        }

        function salvarEvento(e) {
            e.preventDefault();
            const id = document.getElementById('evento-id').value;
            const nome = document.getElementById('nome-evento').value;
            const data = document.getElementById('data-evento').value;
            const valorTotal = parseFloat(document.getElementById('valor-total-evento').value);
            const pagoPelaAssociacao = document.getElementById('pago-pela-associacao').checked;
            const participantesSelect = document.getElementById('participantes-evento');
            const participantesIds = [...participantesSelect.options].filter(option => option.selected).map(option => parseInt(option.value));

            if (participantesIds.length === 0) {
                abrirModalInfo('Atenção', 'Selecione ao menos um participante para o evento.');
                return;
            }
            
            const participantes = participantesIds.map(pId => ({ id: pId, pago: false }));

            if (id) {
                // Lógica de edição (se necessário)
            } else {
                const novoId = eventosDB.length > 0 ? Math.max(...eventosDB.map(e => e.id)) + 1 : 1;
                eventosDB.push({ id: novoId, nome, data, valorTotal, pagoPelaAssociacao, participantes });
                
                if (pagoPelaAssociacao) {
                    const novoLancamentoId = financasDB.length > 0 ? Math.max(...financasDB.map(f => f.id)) + 1 : 1;
                    financasDB.push({
                        id: novoLancamentoId,
                        data: data,
                        descricao: `Pagamento total do evento: ${nome}`,
                        valor: -valorTotal,
                        tipo: 'despesa'
                    });
                }
            }
            
            renderEventos();
            renderLancamentos();
            updateDashboard();
            fecharModal();
        }

        function abrirModalDetalhesEvento(eventoId) {
            const evento = eventosDB.find(e => e.id === eventoId);
            if (!evento) return;

            const valorIndividual = evento.participantes.length > 0 ? (evento.valorTotal / evento.participantes.length) : 0;
            let participantesHtml = '<ul class="space-y-2">';
            evento.participantes.forEach(p => {
                const associado = associadosDB.find(a => a.id === p.id);
                let acao;
                if (p.pago) {
                    acao = '<span class="text-green-600 font-semibold">Pago</span>';
                } else {
                    acao = `<button class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600" onclick="marcarPagamentoEvento(${evento.id}, ${p.id})">Marcar Pago</button>`;
                }
                participantesHtml += `
                    <li class="flex justify-between items-center p-2 bg-gray-100 rounded-md">
                        <span>${associado.nome}</span>
                        ${acao}
                    </li>
                `;
            });
            participantesHtml += '</ul>';
            
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Detalhes do Evento: ${evento.nome}</h2>
                <p class="mb-4">Valor por participante: <strong>R$ ${valorIndividual.toFixed(2).replace('.', ',')}</strong></p>
                ${participantesHtml}
                <div class="mt-6 flex justify-end">
                    <button type="button" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400" onclick="fecharModal()">Fechar</button>
                </div>
            `;
            mostrarModal();
        }

        function marcarPagamentoEvento(eventoId, participanteId) {
            const eventoIndex = eventosDB.findIndex(e => e.id === eventoId);
            if (eventoIndex === -1) return;

            const participanteIndex = eventosDB[eventoIndex].participantes.findIndex(p => p.id === participanteId);
            if (participanteIndex === -1) return;
            
            const evento = eventosDB[eventoIndex];
            eventosDB[eventoIndex].participantes[participanteIndex].pago = true;
            
            if (evento.pagoPelaAssociacao) {
                const associado = associadosDB.find(a => a.id === participanteId);
                const valorIndividual = evento.participantes.length > 0 ? (evento.valorTotal / evento.participantes.length) : 0;
                const novoLancamentoId = financasDB.length > 0 ? Math.max(...financasDB.map(f => f.id)) + 1 : 1;

                financasDB.push({
                    id: novoLancamentoId,
                    data: new Date().toISOString().split('T')[0],
                    descricao: `Reembolso Evento: ${evento.nome} - ${associado.nome}`,
                    valor: valorIndividual,
                    tipo: 'receita'
                });

                renderLancamentos();
                updateDashboard();
            }

            abrirModalDetalhesEvento(eventoId);
        }

        // --- PRODUTOS ---
        function renderProdutos() {
            const lista = document.getElementById('lista-produtos');
            lista.innerHTML = '';
            if (produtosDB.length === 0) {
                lista.innerHTML = '<p class="text-center text-gray-500">Nenhum produto cadastrado.</p>';
                return;
            }
            produtosDB.forEach(produto => {
                const valorIndividual = produto.pedidos.length > 0 ? (produto.custoTotal / produto.pedidos.length).toFixed(2) : 'N/A';
                const card = `
                    <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">${produto.nome}</h3>
                                <p class="text-sm text-gray-600">Variações: ${produto.variacoes.join(', ')}</p>
                                <p class="text-sm text-gray-600">Pedidos: ${produto.pedidos.length}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">Custo Total: R$ ${produto.custoTotal.toFixed(2).replace('.', ',')}</p>
                                <p class="font-semibold text-blue-600">Custo por Unidade: R$ ${valorIndividual.replace('.', ',')}</p>
                                <button class="mt-2 text-sm bg-gray-200 px-3 py-1 rounded-lg hover:bg-gray-300" onclick="abrirModalPedidos(${produto.id})">Ver Pedidos</button>
                            </div>
                        </div>
                    </div>
                `;
                lista.innerHTML += card;
            });
        }

        document.getElementById('btn-novo-produto').addEventListener('click', () => abrirModalProduto());

        function abrirModalProduto(id = null) {
            const produto = id ? produtosDB.find(p => p.id === id) : null;
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">${produto ? 'Editar Produto' : 'Novo Produto'}</h2>
                <form id="form-produto">
                    <input type="hidden" id="produto-id" value="${produto?.id || ''}">
                    <div class="space-y-4">
                        <div><label for="nome-produto" class="block mb-1 font-medium">Nome do Produto</label><input type="text" id="nome-produto" class="w-full p-2 border rounded-lg" value="${produto?.nome || ''}" required></div>
                        <div><label for="custo-total-produto" class="block mb-1 font-medium">Custo Total (R$)</label><input type="number" step="0.01" id="custo-total-produto" class="w-full p-2 border rounded-lg" value="${produto?.custoTotal || ''}" required></div>
                        <div><label for="variacoes-produto" class="block mb-1 font-medium">Variações (ex: P, M, G)</label><input type="text" id="variacoes-produto" class="w-full p-2 border rounded-lg" placeholder="Separados por vírgula" value="${produto?.variacoes.join(', ') || ''}"></div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-4"><button type="button" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400" onclick="fecharModal()">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Produto</button></div>
                </form>
            `;
            document.getElementById('form-produto').addEventListener('submit', salvarProduto);
            mostrarModal();
        }

        function salvarProduto(e) {
            e.preventDefault();
            const id = document.getElementById('produto-id').value;
            const nome = document.getElementById('nome-produto').value;
            const custoTotal = parseFloat(document.getElementById('custo-total-produto').value);
            const variacoes = document.getElementById('variacoes-produto').value.split(',').map(v => v.trim()).filter(v => v);

            if (id) {
                // Lógica de edição
            } else {
                const novoId = produtosDB.length > 0 ? Math.max(...produtosDB.map(p => p.id)) + 1 : 1;
                produtosDB.push({ id: novoId, nome, custoTotal, variacoes, pedidos: [] });
            }
            renderProdutos();
            fecharModal();
        }

        function abrirModalPedidos(produtoId) {
            const produto = produtosDB.find(p => p.id === produtoId);
            if (!produto) return;

            const valorUnitario = produto.pedidos.length > 0 ? (produto.custoTotal / produto.pedidos.length) : produto.custoTotal;
            let pedidosHtml = '<ul class="space-y-2 mb-4">';
            produto.pedidos.forEach(pedido => {
                const associado = associadosDB.find(a => a.id === pedido.associadoId);
                let acao;
                if (pedido.pago) {
                    acao = '<span class="text-green-600 font-semibold">Pago</span>';
                } else {
                    acao = `<button class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600" onclick="marcarPagamentoProduto(${produto.id}, ${pedido.associadoId})">Marcar Pago</button>`;
                }
                pedidosHtml += `
                    <li class="flex justify-between items-center p-2 bg-gray-100 rounded-md">
                        <span>${associado.nome} <span class="text-xs bg-gray-300 px-1 rounded-full">${pedido.variacao}</span></span>
                        ${acao}
                    </li>
                `;
            });
            pedidosHtml += '</ul>';

            const associadosSemPedido = associadosDB.filter(a => !produto.pedidos.some(p => p.associadoId === a.id) && a.status === 'ativo');
            let associadoOptions = associadosSemPedido.map(a => `<option value="${a.id}">${a.nome}</option>`).join('');
            let variacaoOptions = produto.variacoes.map(v => `<option value="${v}">${v}</option>`).join('');

            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Pedidos de: ${produto.nome}</h2>
                <p class="mb-4">Valor por unidade: <strong>R$ ${valorUnitario.toFixed(2).replace('.', ',')}</strong></p>
                <div class="max-h-60 overflow-y-auto">${pedidosHtml}</div>
                <hr class="my-4">
                <h3 class="text-lg font-semibold mb-2">Adicionar Novo Pedido</h3>
                <form id="form-novo-pedido" class="grid grid-cols-3 gap-2 items-end">
                    <div class="col-span-3 sm:col-span-1">
                        <label for="select-associado-pedido" class="text-sm">Associado</label>
                        <select id="select-associado-pedido" class="w-full p-2 border rounded-lg">${associadoOptions}</select>
                    </div>
                    <div class="col-span-3 sm:col-span-1">
                        <label for="select-variacao-pedido" class="text-sm">Variação</label>
                        <select id="select-variacao-pedido" class="w-full p-2 border rounded-lg">${variacaoOptions}</select>
                    </div>
                    <div class="col-span-3 sm:col-span-1">
                        <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Adicionar</button>
                    </div>
                </form>
                <div class="mt-6 flex justify-end">
                    <button type="button" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400" onclick="fecharModal()">Fechar</button>
                </div>
            `;

            document.getElementById('form-novo-pedido').addEventListener('submit', (e) => {
                e.preventDefault();
                const associadoId = parseInt(document.getElementById('select-associado-pedido').value);
                const variacao = document.getElementById('select-variacao-pedido').value;
                if (associadoId && variacao) {
                    adicionarPedido(produtoId, associadoId, variacao);
                }
            });
            mostrarModal();
        }

        function adicionarPedido(produtoId, associadoId, variacao) {
            const produtoIndex = produtosDB.findIndex(p => p.id === produtoId);
            if (produtoIndex === -1) return;
            produtosDB[produtoIndex].pedidos.push({ associadoId, variacao, pago: false });
            renderProdutos();
            abrirModalPedidos(produtoId);
        }

        function marcarPagamentoProduto(produtoId, associadoId) {
            const produtoIndex = produtosDB.findIndex(p => p.id === produtoId);
            if (produtoIndex === -1) return;
            const pedidoIndex = produtosDB[produtoIndex].pedidos.findIndex(p => p.associadoId === associadoId);
            if (pedidoIndex === -1) return;

            produtosDB[produtoIndex].pedidos[pedidoIndex].pago = true;
            
            const produto = produtosDB[produtoIndex];
            const associado = associadosDB.find(a => a.id === associadoId);
            const valorUnitario = produto.pedidos.length > 0 ? (produto.custoTotal / produto.pedidos.length) : 0;
            
            const novoLancamentoId = financasDB.length > 0 ? Math.max(...financasDB.map(f => f.id)) + 1 : 1;
            financasDB.push({
                id: novoLancamentoId,
                data: new Date().toISOString().split('T')[0],
                descricao: `Pagamento Produto: ${produto.nome} - ${associado.nome}`,
                valor: valorUnitario,
                tipo: 'receita'
            });

            renderLancamentos();
            updateDashboard();
            abrirModalPedidos(produtoId);
        }

        // --- FINANCEIRO ---
        function renderLancamentos() {
            const lista = document.getElementById('lista-lancamentos');
            const filtroTipo = document.getElementById('filter-lancamento-tipo').value;
            lista.innerHTML = '';

            const filteredData = financasDB.filter(item => {
                return (filtroTipo === 'todos') || (item.tipo === filtroTipo);
            });

            const sortedFinancas = filteredData.sort((a, b) => new Date(b.data) - new Date(a.data));

            if (sortedFinancas.length === 0) {
                lista.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-gray-500">Nenhum lançamento encontrado.</td></tr>';
                return;
            }

            sortedFinancas.forEach(item => {
                const valorClass = item.valor > 0 ? 'text-green-600' : 'text-red-600';
                const row = `<tr class="border-b hover:bg-gray-50"><td class="p-3">${formatarData(item.data)}</td><td class="p-3">${item.descricao}</td><td class="p-3 font-medium ${valorClass}">R$ ${Math.abs(item.valor).toFixed(2).replace('.', ',')}</td><td class="p-3">${item.tipo}</td><td class="p-3 no-print"><button class="text-blue-600 hover:text-blue-800 mr-3" onclick="abrirModalLancamento(${item.id})"><i class="fas fa-edit"></i></button><button class="text-red-600 hover:text-red-800" onclick="deletarLancamento(${item.id})"><i class="fas fa-trash"></i></button></td></tr>`;
                lista.innerHTML += row;
            });
        }
        
        function renderMensalidades() {
            const container = document.getElementById('lista-mensalidades-container');
            container.innerHTML = '';
            
            const mensalidadesAgrupadas = mensalidadesDB.reduce((acc, m) => {
                const data = new Date(m.vencimento + 'T00:00:00');
                const mesAno = `${data.toLocaleString('pt-BR', { month: 'long' })}/${data.getFullYear()}`;
                if (!acc[mesAno]) {
                    acc[mesAno] = [];
                }
                acc[mesAno].push(m);
                return acc;
            }, {});

            const sortedKeys = Object.keys(mensalidadesAgrupadas).sort((a, b) => {
                const [mesA, anoA] = a.split('/');
                const [mesB, anoB] = b.split('/');
                const dataA = new Date(anoA, new Date(Date.parse(mesA +" 1, 2012")).getMonth());
                const dataB = new Date(anoB, new Date(Date.parse(mesB +" 1, 2012")).getMonth());
                return dataB - dataA;
            });

            if (sortedKeys.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Nenhuma mensalidade encontrada. Gere as mensalidades do mês.</p>';
                return;
            }

            sortedKeys.forEach(mesAno => {
                const mensalidadesDoMes = mensalidadesAgrupadas[mesAno];
                let tableRows = '';

                mensalidadesDoMes.forEach(mensalidade => {
                    const associado = associadosDB.find(a => a.id === mensalidade.associadoId);
                    if (!associado) return;

                    let statusClass, statusText, acaoButton;
                    const hoje = new Date().toISOString().split('T')[0];

                    if (mensalidade.status === 'paga') {
                        statusClass = 'text-green-600 bg-green-100';
                        statusText = 'Paga';
                        acaoButton = '<span class="text-gray-400">Pago</span>';
                    } else if (mensalidade.vencimento < hoje) {
                        statusClass = 'text-red-600 bg-red-100';
                        statusText = 'Vencida';
                        acaoButton = `<button class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600" onclick="marcarComoPaga(${mensalidade.id})">Marcar Paga</button>`;
                    } else {
                        statusClass = 'text-yellow-600 bg-yellow-100';
                        statusText = 'Em Aberto';
                        acaoButton = `<button class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600" onclick="marcarComoPaga(${mensalidade.id})">Marcar Paga</button>`;
                    }

                    tableRows += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3 font-medium">${associado.nome}</td>
                            <td class="p-3">${formatarData(mensalidade.vencimento)}</td>
                            <td class="p-3">R$ ${mensalidade.valor.toFixed(2).replace('.', ',')}</td>
                            <td class="p-3"><span class="px-2 py-1 rounded-full text-sm font-semibold ${statusClass}">${statusText}</span></td>
                            <td class="p-3 no-print">${acaoButton}</td>
                        </tr>
                    `;
                });

                const section = `
                    <details open>
                        <summary class="text-lg font-bold cursor-pointer hover:text-blue-600 capitalize">${mesAno}</summary>
                        <div class="overflow-x-auto mt-2">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-gray-200">
                                        <th class="p-3">Associado</th>
                                        <th class="p-3">Vencimento</th>
                                        <th class="p-3">Valor</th>
                                        <th class="p-3">Status</th>
                                        <th class="p-3 no-print">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>${tableRows}</tbody>
                            </table>
                        </div>
                    </details>
                `;
                container.innerHTML += section;
            });
        }
        
        document.getElementById('btn-gerar-mensalidades').addEventListener('click', () => {
            abrirModalConfirmacao(
                'Gerar Mensalidades do Mês',
                'Deseja gerar as mensalidades para todos os associados ativos para o mês atual? Esta ação não pode ser desfeita.',
                gerarMensalidades
            );
        });

        function gerarMensalidades() {
            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = hoje.getMonth(); // 0-11
            const diaVencimento = document.getElementById('dia-vencimento').value;
            const vencimento = new Date(ano, mes, diaVencimento).toISOString().split('T')[0];

            const associadosAtivos = associadosDB.filter(a => a.status === 'ativo');
            let geradas = 0;

            associadosAtivos.forEach(assoc => {
                const jaExiste = mensalidadesDB.some(m => 
                    m.associadoId === assoc.id && 
                    new Date(m.vencimento).getFullYear() === ano &&
                    new Date(m.vencimento).getMonth() === mes
                );

                if (!jaExiste) {
                    const novaId = mensalidadesDB.length > 0 ? Math.max(...mensalidadesDB.map(m => m.id)) + 1 : 1;
                    mensalidadesDB.push({
                        id: novaId,
                        associadoId: assoc.id,
                        vencimento: vencimento,
                        valor: assoc.mensalidade,
                        status: 'em_aberto'
                    });
                    geradas++;
                }
            });
            
            abrirModalInfo('Sucesso!', `${geradas} mensalidades foram geradas com sucesso.`);
            renderMensalidades();
        }

        function marcarComoPaga(mensalidadeId) {
            const index = mensalidadesDB.findIndex(m => m.id === mensalidadeId);
            if (index === -1) return;

            mensalidadesDB[index].status = 'paga';
            const mensalidade = mensalidadesDB[index];
            const associado = associadosDB.find(a => a.id === mensalidade.associadoId);

            const novaIdFinanceiro = financasDB.length > 0 ? Math.max(...financasDB.map(f => f.id)) + 1 : 1;
            financasDB.push({
                id: novaIdFinanceiro,
                data: new Date().toISOString().split('T')[0],
                descricao: `Mensalidade ${associado.nome}`,
                valor: mensalidade.valor,
                tipo: 'receita'
            });

            renderMensalidades();
            renderLancamentos();
            updateDashboard();
        }

        document.getElementById('btn-nova-receita').addEventListener('click', () => abrirModalLancamento(null, 'receita'));
        document.getElementById('btn-nova-despesa').addEventListener('click', () => abrirModalLancamento(null, 'despesa'));

        function abrirModalLancamento(id = null, tipoDefault = 'receita') {
            const lancamento = id ? financasDB.find(l => l.id === id) : null;
            const tipo = lancamento ? (lancamento.valor > 0 ? 'receita' : 'despesa') : tipoDefault;

            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">${lancamento ? 'Editar Lançamento' : (tipo === 'receita' ? 'Nova Receita Avulsa' : 'Nova Despesa')}</h2>
                <form id="form-lancamento">
                    <input type="hidden" id="lancamento-id" value="${lancamento?.id || ''}">
                    <div class="space-y-4">
                        <div><label for="descricao" class="block mb-1 font-medium">Descrição</label><input type="text" id="descricao" class="w-full p-2 border rounded-lg" value="${lancamento?.descricao || ''}" required></div>
                        <div><label for="valor" class="block mb-1 font-medium">Valor (R$)</label><input type="number" step="0.01" id="valor" class="w-full p-2 border rounded-lg" value="${lancamento ? Math.abs(lancamento.valor) : ''}" required></div>
                        <div><label for="data" class="block mb-1 font-medium">Data</label><input type="date" id="data" class="w-full p-2 border rounded-lg" value="${lancamento?.data || new Date().toISOString().split('T')[0]}" required></div>
                        <input type="hidden" id="tipo" value="${tipo}">
                    </div>
                    <div class="mt-6 flex justify-end space-x-4"><button type="button" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400" onclick="fecharModal()">Cancelar</button><button type="submit" class="px-4 py-2 ${tipo === 'receita' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'} text-white rounded-lg">Salvar</button></div>
                </form>
            `;
            document.getElementById('form-lancamento').addEventListener('submit', salvarLancamento);
            mostrarModal();
        }

        function salvarLancamento(e) {
            e.preventDefault();
            const id = document.getElementById('lancamento-id').value;
            const descricao = document.getElementById('descricao').value;
            let valor = parseFloat(document.getElementById('valor').value);
            const data = document.getElementById('data').value;
            const tipo = document.getElementById('tipo').value;

            if (tipo === 'despesa') valor = -valor;

            if (id) {
                const index = financasDB.findIndex(l => l.id == id);
                financasDB[index] = { ...financasDB[index], descricao, valor, data, tipo: valor > 0 ? 'receita' : 'despesa' };
            } else {
                const novoId = financasDB.length > 0 ? Math.max(...financasDB.map(l => l.id)) + 1 : 1;
                financasDB.push({ id: novoId, descricao, valor, data, tipo: valor > 0 ? 'receita' : 'despesa' });
            }

            renderLancamentos();
            updateDashboard();
            fecharModal();
        }
        
        function deletarLancamento(id) {
            abrirModalConfirmacao(
                'Excluir Lançamento',
                'Tem certeza que deseja excluir este lançamento? Esta ação é irreversível.',
                () => {
                    financasDB = financasDB.filter(l => l.id !== id);
                    renderLancamentos();
                    updateDashboard();
                    fecharModal();
                }
            );
        }


        // --- RELATÓRIOS ---
        function renderBotoesRelatorioProduto() {
            const container = document.getElementById('relatorios-produtos-container');
            container.innerHTML = '';
            produtosDB.forEach(produto => {
                const button = document.createElement('button');
                button.className = 'block w-full text-left bg-gray-200 p-3 rounded-lg hover:bg-gray-300 mb-2';
                button.textContent = `Pedidos: ${produto.nome}`;
                button.onclick = () => gerarRelatorio(`pedido-produto-${produto.id}`);
                container.appendChild(button);
            });
        }

        function gerarRelatorio(tipo) {
            const container = document.getElementById('relatorio-gerado');
            container.innerHTML = '';
            let content = '';
            
            const dataInicio = document.getElementById('filtro-data-inicio').value;
            const dataFim = document.getElementById('filtro-data-fim').value;

            if (tipo === 'aviso-mensalidade') {
                const hoje = new Date();
                const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                const mesAtual = meses[hoje.getMonth()];
                const anoAtual = hoje.getFullYear();
                const diaVencimento = config.diaVencimentoPadrao;
                const chavePix = config.chavePix || '[Chave PIX não configurada]';

                const aviso = `Prezados associados!\n\nLembramos que a mensalidade de ${mesAtual}/${anoAtual} está disponível para pagamento.\n\nVencimento: ${diaVencimento}/${hoje.getMonth() + 1}/${anoAtual}\n\nChave PIX para pagamento: ${chavePix}\n\nContamos com a colaboração de todos para mantermos nossa associação forte!`;
                
                abrirModalAviso(aviso);
                return;
            }

            const header = `<div class="flex items-center justify-between mb-6"><img src="${logoURL}" class="h-20 w-20 rounded-full object-cover" alt="Logo"><div><h3 class="text-2xl font-bold text-right">Relatório de ${tipo.replace(/-/g, ' ')}</h3><p class="text-right text-gray-500">Gerado em: ${new Date().toLocaleDateString('pt-BR')}</p></div></div>`;

            const filterByDate = (item) => {
                if (!dataInicio || !dataFim) return true;
                const itemDate = item.data || item.vencimento;
                return itemDate >= dataInicio && itemDate <= dataFim;
            };

            switch (true) {
                case tipo.startsWith('pedido-produto-'):
                    const produtoId = parseInt(tipo.split('-')[2]);
                    const produto = produtosDB.find(p => p.id === produtoId);
                    content += `<h4 class="text-lg font-semibold mt-4 mb-2">${produto.nome}</h4>`;
                    const pedidosData = produto.pedidos.map(p => {
                        const associado = associadosDB.find(a => a.id === p.associadoId);
                        return [associado.nome, p.variacao, p.pago ? 'Sim' : 'Não'];
                    });
                    content += gerarTabela(['Associado', 'Variação', 'Pago?'], pedidosData);
                    break;
                case tipo === 'fluxo-caixa':
                    content = gerarTabela(['Data', 'Descrição', 'Valor', 'Tipo'], financasDB.filter(filterByDate).map(f => [formatarData(f.data), f.descricao, `R$ ${f.valor.toFixed(2).replace('.', ',')}`, f.tipo]));
                    break;
                case tipo === 'inadimplentes':
                    const hoje = new Date().toISOString().split('T')[0];
                    content = gerarTabela(['Nome', 'Email', 'Mensalidade Vencida', 'Vencimento'], mensalidadesDB.filter(m => m.status === 'em_aberto' && m.vencimento < hoje && filterByDate(m)).map(m => {
                        const assoc = associadosDB.find(a => a.id === m.associadoId);
                        return [assoc.nome, assoc.email, `R$ ${m.valor.toFixed(2).replace('.', ',')}`, formatarData(m.vencimento)];
                    }));
                    break;
                case tipo === 'associados-status':
                    content = gerarTabela(['Nome', 'Status', 'Email', 'Telefone'], associadosDB.map(a => [a.nome, a.status, a.email, a.telefone]));
                    break;
                case tipo === 'eventos':
                    content = gerarTabela(['Nome do Evento', 'Data', 'Custo Total', 'Participantes'], eventosDB.filter(filterByDate).map(e => [e.nome, formatarData(e.data), `R$ ${e.valorTotal.toFixed(2).replace('.',',')}`, e.participantes.length]));
                    break;
                case tipo === 'financeiro-consolidado':
                    const financasFiltradas = financasDB.filter(filterByDate);
                    const receitas = financasFiltradas.filter(f => f.tipo === 'receita').reduce((sum, f) => sum + f.valor, 0);
                    const despesas = financasFiltradas.filter(f => f.tipo === 'despesa').reduce((sum, f) => sum + f.valor, 0);
                    const saldo = receitas + despesas;
                    content = `<div class="space-y-4 text-lg"><div class="flex justify-between p-4 bg-green-100 rounded-lg"><span>Total de Receitas:</span> <span class="font-bold">R$ ${receitas.toFixed(2).replace('.', ',')}</span></div><div class="flex justify-between p-4 bg-red-100 rounded-lg"><span>Total de Despesas:</span> <span class="font-bold">R$ ${Math.abs(despesas).toFixed(2).replace('.', ',')}</span></div><div class="flex justify-between p-4 bg-blue-100 rounded-lg"><span>Saldo Final:</span> <span class="font-bold">R$ ${saldo.toFixed(2).replace('.', ',')}</span></div></div>`;
                    break;
            }

            container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md printable-area">${header}${content}</div><div class="mt-4 space-x-2 no-print"><button class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700" onclick="window.print()"><i class="fas fa-print mr-2"></i>Imprimir</button><button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" onclick="baixarRelatorioPDF('${tipo}')"><i class="fas fa-file-pdf mr-2"></i>Baixar PDF</button></div>`;
        }

        function gerarTabela(headers, rows) {
            let table = '<div class="overflow-x-auto"><table class="w-full text-left">';
            table += '<thead><tr class="bg-gray-200">';
            headers.forEach(h => table += `<th class="p-3">${h}</th>`);
            table += '</tr></thead><tbody>';
            if (rows.length === 0) {
                table += `<tr><td colspan="${headers.length}" class="p-3 text-center">Nenhum dado para exibir.</td></tr>`;
            } else {
                rows.forEach(row => {
                    table += '<tr class="border-b">';
                    row.forEach(cell => table += `<td class="p-3">${cell}</td>`);
                    table += '</tr>';
                });
            }
            table += '</tbody></table></div>';
            return table;
        }
        
        function baixarRelatorioPDF(tipo) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const addContentToPDF = () => {
                // WATERMARK
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const watermarkWidth = pageWidth * 0.7;
                const watermarkHeight = watermarkWidth; 
                const x = (pageWidth - watermarkWidth) / 2;
                const y = (pageHeight - watermarkHeight) / 2;

                doc.saveGraphicsState();
                doc.setGState(new doc.GState({opacity: 0.1}));
                try {
                    doc.addImage(logoURL, 'PNG', x, y, watermarkWidth, watermarkHeight);
                } catch (e) {
                    console.warn("Não foi possível adicionar a imagem da marca d'água.", e);
                }
                doc.restoreGraphicsState();
                
                // HEADER LOGO
                try {
                    doc.addImage(logoURL, 'PNG', 15, 10, 25, 25);
                } catch (e) {
                    console.warn("Não foi possível adicionar o logo do cabeçalho.", e);
                }

                // HEADER TEXT
                doc.setFontSize(18);
                doc.text(`Relatório de ${tipo.replace(/-/g, ' ')}`, 105, 20, { align: 'center' });
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 105, 26, { align: 'center' });

                let head = [];
                let body = [];
                let startY = 45;
                
                const dataInicio = document.getElementById('filtro-data-inicio').value;
                const dataFim = document.getElementById('filtro-data-fim').value;
                const filterByDate = (item) => {
                    if (!dataInicio || !dataFim) return true;
                    const itemDate = item.data || item.vencimento;
                    return itemDate >= dataInicio && itemDate <= dataFim;
                };

                switch (true) {
                    case tipo.startsWith('pedido-produto-'):
                        const produtoId = parseInt(tipo.split('-')[2]);
                        const produto = produtosDB.find(p => p.id === produtoId);
                        doc.setFontSize(14).setFont(undefined, 'bold');
                        doc.text(produto.nome, 15, startY);
                        startY += 8;
                        const pedidosData = produto.pedidos.map(p => {
                            const associado = associadosDB.find(a => a.id === p.associadoId);
                            return [associado.nome, p.variacao, p.pago ? 'Sim' : 'Não'];
                        });
                        head = [['Associado', 'Variação', 'Pago?']];
                        body = pedidosData;
                        break;
                    case tipo === 'fluxo-caixa':
                        head = [['Data', 'Descrição', 'Valor', 'Tipo']];
                        body = financasDB.filter(filterByDate).map(f => [formatarData(f.data), f.descricao, `R$ ${f.valor.toFixed(2).replace('.', ',')}`, f.tipo]);
                        break;
                    case tipo === 'inadimplentes':
                        const hoje = new Date().toISOString().split('T')[0];
                        head = [['Nome', 'Email', 'Mensalidade Vencida', 'Vencimento']];
                        body = mensalidadesDB.filter(m => m.status === 'em_aberto' && m.vencimento < hoje && filterByDate(m)).map(m => {
                            const assoc = associadosDB.find(a => a.id === m.associadoId);
                            return [assoc.nome, assoc.email, `R$ ${m.valor.toFixed(2).replace('.', ',')}`, formatarData(m.vencimento)];
                        });
                        break;
                    case tipo === 'associados-status':
                        head = [['Nome', 'Status', 'Email', 'Telefone']];
                        body = associadosDB.map(a => [a.nome, a.status, a.email, a.telefone]);
                        break;
                    case tipo === 'eventos':
                        head = [['Nome do Evento', 'Data', 'Custo Total', 'Participantes']];
                        body = eventosDB.filter(filterByDate).map(e => [e.nome, formatarData(e.data), `R$ ${e.valorTotal.toFixed(2).replace('.',',')}`, e.participantes.length]);
                        break;
                    case tipo === 'financeiro-consolidado':
                        const financasFiltradas = financasDB.filter(filterByDate);
                        const receitas = financasFiltradas.filter(f => f.tipo === 'receita').reduce((sum, f) => sum + f.valor, 0);
                        const despesas = financasFiltradas.filter(f => f.tipo === 'despesa').reduce((sum, f) => sum + f.valor, 0);
                        const saldo = receitas + despesas;
                        doc.setFontSize(12);
                        doc.text(`Total de Receitas: R$ ${receitas.toFixed(2).replace('.', ',')}`, 15, startY);
                        doc.text(`Total de Despesas: R$ ${Math.abs(despesas).toFixed(2).replace('.', ',')}`, 15, startY + 10);
                        doc.setFontSize(12).setFont(undefined, 'bold');
                        doc.text(`Saldo Final: R$ ${saldo.toFixed(2).replace('.', ',')}`, 15, startY + 20);
                        break;
                }

                if (head.length > 0) {
                    doc.autoTable({ head, body, startY, theme: 'grid' });
                }

                doc.save(`relatorio_${tipo}_${new Date().toISOString().split('T')[0]}.pdf`);
            };
            
            addContentToPDF();
        }


        // --- CONFIGURAÇÕES ---
        const logoUpload = document.getElementById('logo-upload');
        const logoPreview = document.getElementById('logo-preview');
        const sidebarLogo = document.getElementById('sidebar-logo');

        logoUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    logoURL = event.target.result;
                    logoPreview.src = logoURL;
                    sidebarLogo.src = logoURL;
                    updateWatermark();
                };
                reader.readAsDataURL(file);
            }
        });
        
        document.getElementById('dia-vencimento').addEventListener('change', (e) => {
            config.diaVencimentoPadrao = parseInt(e.target.value);
        });
        document.getElementById('chave-pix').addEventListener('change', (e) => {
            config.chavePix = e.target.value;
        });
        
        function renderUsuarios() {
            const lista = document.getElementById('lista-usuarios');
            lista.innerHTML = '';
            usuariosDB.forEach(user => {
                const row = `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-medium">${user.nome}</td>
                        <td class="p-3">${user.email}</td>
                        <td class="p-3">${user.permissao}</td>
                        <td class="p-3 no-print">
                            <button class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button>
                            <button class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                lista.innerHTML += row;
            });
        }

        document.getElementById('btn-novo-usuario').addEventListener('click', () => abrirModalUsuario());

        function abrirModalUsuario(id = null) {
            const usuario = id ? usuariosDB.find(u => u.id === id) : null;
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">${usuario ? 'Editar Usuário' : 'Novo Usuário'}</h2>
                <form id="form-usuario">
                    <input type="hidden" id="usuario-id" value="${usuario?.id || ''}">
                    <div class="space-y-4">
                        <div><label for="nome-usuario" class="block mb-1 font-medium">Nome</label><input type="text" id="nome-usuario" class="w-full p-2 border rounded-lg" value="${usuario?.nome || ''}" required></div>
                        <div><label for="email-usuario" class="block mb-1 font-medium">Email</label><input type="email" id="email-usuario" class="w-full p-2 border rounded-lg" value="${usuario?.email || ''}" required></div>
                        <div><label for="permissao-usuario" class="block mb-1 font-medium">Permissão</label>
                            <select id="permissao-usuario" class="w-full p-2 border rounded-lg">
                                <option value="Administrador" ${usuario?.permissao === 'Administrador' ? 'selected' : ''}>Administrador</option>
                                <option value="Usuário" ${usuario?.permissao === 'Usuário' ? 'selected' : ''}>Usuário</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-4"><button type="button" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400" onclick="fecharModal()">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar</button></div>
                </form>
            `;
            document.getElementById('form-usuario').addEventListener('submit', salvarUsuario);
            mostrarModal();
        }

        function salvarUsuario(e) {
            e.preventDefault();
            const id = document.getElementById('usuario-id').value;
            const nome = document.getElementById('nome-usuario').value;
            const email = document.getElementById('email-usuario').value;
            const permissao = document.getElementById('permissao-usuario').value;

            if (id) {
                const index = usuariosDB.findIndex(u => u.id == id);
                usuariosDB[index] = { ...usuariosDB[index], nome, email, permissao };
            } else {
                const novoId = usuariosDB.length > 0 ? Math.max(...usuariosDB.map(u => u.id)) + 1 : 1;
                usuariosDB.push({ id: novoId, nome, email, permissao });
            }
            renderUsuarios();
            fecharModal();
        }


        // --- LÓGICA DO MODAL ---
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');

        function mostrarModal() {
            modal.classList.remove('hidden');
            setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 10);
        }

        function fecharModal() {
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }
        
        function abrirModalInfo(titulo, mensagem) {
            modalContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">${titulo}</h2><p>${mensagem}</p><div class="mt-6 flex justify-end"><button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" onclick="fecharModal()">OK</button></div>`;
            mostrarModal();
        }
        
        function abrirModalAviso(texto) {
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Aviso de Mensalidade</h2>
                <textarea id="aviso-texto" class="w-full h-48 p-2 border rounded-lg bg-gray-50" readonly>${texto}</textarea>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400" onclick="fecharModal()">Fechar</button>
                    <button type="button" id="btn-copiar-aviso" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Copiar Texto</button>
                </div>
            `;
            document.getElementById('btn-copiar-aviso').addEventListener('click', (e) => {
                const textoParaCopiar = document.getElementById('aviso-texto');
                textoParaCopiar.select();
                document.execCommand('copy');
                e.target.textContent = 'Copiado!';
                setTimeout(() => { e.target.textContent = 'Copiar Texto'; }, 2000);
            });
            mostrarModal();
        }

        function abrirModalConfirmacao(titulo, mensagem, callback) {
            modalContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">${titulo}</h2><p>${mensagem}</p><div class="mt-6 flex justify-end space-x-4"><button type="button" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400" onclick="fecharModal()">Cancelar</button><button type="button" id="btn-confirmar-acao" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Confirmar</button></div>`;
            document.getElementById('btn-confirmar-acao').onclick = () => {
                callback();
                if (!document.querySelector('#form-evento')) { // Hack to prevent double-closing
                    fecharModal();
                }
            };
            mostrarModal();
        }

        modal.addEventListener('click', (e) => { if (e.target === modal) fecharModal(); });

    </script>
</body>
</html>
